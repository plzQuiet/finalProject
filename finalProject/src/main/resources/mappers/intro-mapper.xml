<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="introMapper">

	<resultMap type="Board" id="board_rm">
   
      <id property="boardNo" column="BOARD_NO"/>
      
      <result property="boardTitle" column="BOARD_TITLE"/>
      <result property="boardContent" column="BOARD_CONTENT"/>
      <result property="boardCreateDate" column="B_CREATE_DT"/>
      <result property="boardUpdateDate" column="B_UPDATE_DT"/>
      <result property="readCount" column="READ_COUNT"/>
      <result property="boardDeleteFlag" column="BOARD_DEL_FL"/>
      <result property="boardScreatFlag" column="BOARD_SC_FL"/>
      <result property="memberNo" column="MEMBER_NO"/>
      <result property="memberName" column="MEMBER_NAME"/>
      <result property="cateCode" column="CAT_CODE"/>
      
      <collection property="imageList" 
      				select="selectImageList" 
      				column="BOARD_NO"
      				javaType="java.util.ArrayList"
      				ofType="BoardImage">
      </collection>
      
   </resultMap>
   
    <!-- BoardImage DTO에 대한 resultMap -->
   <resultMap type="BoardImage" id="boardImage_rm">
   	<id property="imageNo" column="IMG_NO"/>
   	
   	<result property="boardNo" column="BOARD_NO"/>
   	<result property="imagePath" column="IMG_PATH"/>
   	<result property="imageOriginal" column="IMG_ORIGINAL"/>
   	<result property="imageReName" column="IMG_RENAME"/>
   	<result property="imageOrder" column="IMG_ORDER"/>
   </resultMap>
   
   <!-- BoardImage DTO에 대한 resultMap -->
   <resultMap type="LibAnother" id="libAnother_rm">
   	<id property="boardNo" column="BOARD_NO"/>
   	
   	<result property="libraryAddress" column="LIBRARY_ADDRESS"/>
   	<result property="searchLat" column="LIBRARY_LATITUDE"/>
   	<result property="searchLng" column="LIBRARY_LONGITUDE"/>
   	
   </resultMap>

	<!-- 카테고리 가져오기 -->
	<select id="selectCategoryList" resultType="map">
		SELECT LEVEL , C.* FROM
		    (SELECT * FROM CATEGORY) C
		START WITH PARENT_CODE IS NULL
		CONNECT BY PRIOR CAT_CODE = PARENT_CODE
		ORDER SIBLINGS BY PARENT_CODE
	</select>
	
	<!-- 도서관 명 가져오기 -->
	<select id="getAnLib" parameterType="_int" resultType="map">
		SELECT BOARD_NO, BOARD_TITLE FROM BOARD
		WHERE CAT_CODE = #{catLevel3}
		AND BOARD_DEL_FL = 'N'
		ORDER BY BOARD_NO
	</select>
	
	<!-- 주변 도서관 삽입 -->
	<insert id="anLibInsert" parameterType="Board" useGeneratedKeys="true">
		
		<selectKey order="BEFORE" resultType="_int" keyProperty="boardNo">
			SELECT SEQ_BOARD_NO.NEXTVAL FROM DUAL
		</selectKey>
		
		INSERT INTO BOARD
		VALUES (#{boardNo},
				#{memberNo},
				#{cateCode},
				#{boardTitle},
				#{boardContent},
				DEFAULT, NULL, DEFAULT, DEFAULT, DEFAULT
		)
	
	</insert>
	
	<!-- 주변 도서관 이미지 리스트(여러개) 삽입 -->
	<insert id="insertImageList" parameterType="list">
		INSERT INTO BOARD_IMG
		SELECT SEQ_IMG_NO.NEXTVAL, A.*
		FROM (
		
			<foreach collection="list" item="img" separator=" UNION ALL ">
				SELECT 
				#{img.boardNo} BOARD_NO, 
				#{img.imagePath} IMG_PATH,
				#{img.imageOriginal} IMG_ORIGINAL, 
				#{img.imageReName} IMG_RENAME,
				#{img.imageOrder} IMG_ORDER
				FROM DUAL
			</foreach>
		)A
	
	</insert>
	
	<insert id="insertLibAn" parameterType="LibAnother">
		INSERT INTO LIBRARY_ANOTHER
		VALUES( #{boardNo},
				#{libraryAddress},
				#{searchLat},
				#{searchLng}
		)
	</insert>
	
	<!-- 주변 도서관 상세 조회 -->
	<select id="getAnLibBoard" resultMap="board_rm">
		SELECT BOARD_NO, BOARD_TITLE, BOARD_CONTENT
		FROM BOARD
		WHERE BOARD_DEL_FL = 'N'
		AND BOARD_NO = ${boardNo}
		AND CAT_CODE = ${catLevel3}
	</select>
	
	<!-- 주변 도서관 이미지 조회 -->
	<select id="selectImageList" resultMap="boardImage_rm">
		SELECT * FROM BOARD_IMG
		WHERE BOARD_NO = ${boardNo}
		ORDER BY IMG_ORDER
	</select>
	
	<!-- 주변 도서관 주소, 위도, 경도 -->
	<select id="getAnAdd" resultMap="libAnother_rm">
		SELECT * FROM LIBRARY_ANOTHER
		JOIN BOARD USING(BOARD_NO)
		WHERE BOARD_NO = ${boardNo}
		AND BOARD_DEL_FL = 'N'
	</select>
	
	<!-- 주변 도서관 제목 내용 수정 -->
	<update id="updateLibAn">
		UPDATE BOARD SET
		BOARD_TITLE = #{boardTitle},
		BOARD_CONTENT = #{boardContent},
		B_UPDATE_DT = SYSDATE
		WHERE CAT_CODE = ${cateCode}
		AND BOARD_NO = ${boardNo}
	</update>
	
	<!-- 주변 도서관 수정시 이미지 삭제 -->
	<delete id="deleteImageList">
		DELETE FROM BOARD_IMG
		WHERE BOARD_NO = ${boardNo}
		AND IMG_ORDER IN(${deleteList})
	</delete>
	
	<!-- 주변 도서관 수정시 이미지 수정 -->
	<update id="updateImage">
		UPDATE BOARD_IMG SET
		IMG_RENAME = #{imageReName},
		IMG_ORIGINAL = #{imageOriginal}
		WHERE BOARD_NO = ${boardNo}
		AND IMG_ORDER = ${imageOrder}
	</update>
	
	<!-- 주변 도서관 수정시 이미지 삽입 -->
	<insert id="insertImage">
		INSERT INTO BOARD_IMG
		VALUES(SEQ_IMG_NO.NEXTVAL,
			#{boardNo},
			#{imagePath},
			#{imageOriginal},
			#{imageReName},
			#{imageOrder}
		)
	</insert>
	
	<!-- 주변 도서관 수정시 주소, 위도, 경도 수정 -->
	<update id="updateLibAdd">
		UPDATE LIBRARY_ANOTHER SET
		LIBRARY_ADDRESS = #{libraryAddress},
		LIBRARY_LATITUDE = #{searchLat},
		LIBRARY_LONGITUDE = #{searchLng}
		WHERE BOARD_NO = #{boardNo}
	</update>
	
	<!-- 주변 도서관 삭제 -->
	<update id="deleteLibAdd">
		UPDATE BOARD SET
		BOARD_DEL_FL = 'Y'
		WHERE BOARD_NO = ${boardNo}
	</update>

</mapper>
